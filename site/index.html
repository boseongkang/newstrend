<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>News Trends</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>window.Chart||document.write('<script src="https://unpkg.com/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous"><\/script>')</script>
<script>window.Chart||document.write('<script src="./vendor/chart.umd.min.js"><\/script>')</script>
<style>
  body{margin:0;background:#0b0f18;color:#e6e8ec;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px;position:relative}
  h1{font-size:24px;margin:0 0 16px}
  .nav{position:absolute;right:16px;top:12px;display:flex;gap:8px}
  .pill{background:#253bff;color:#fff;border-radius:10px;padding:8px 12px;text-decoration:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#121826;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input{background:#0f1523;border:1px solid #243043;color:#e6e8ec;border-radius:10px;padding:10px 12px;min-width:220px}
  button{background:#253bff;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .hint{opacity:.7;font-size:12px;margin-top:6px}
  canvas{width:100%;height:360px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px}
  .sheet{max-width:900px;width:100%;max-height:80vh;overflow:auto;background:#0f1523;border:1px solid #243043;border-radius:12px;padding:16px}
  .sec{margin-bottom:10px}
  .sec h4{margin:10px 0}
  .grid2{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .sectbar{display:flex;justify-content:space-between;align-items:center}
  .sbtn{background:#263249;border:1px solid #2f3b57;color:#cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <a href="./index.html" class="pill">Trends</a>
    <a href="./report.html" class="pill">Report</a>
    <a href="./rising.html" class="pill">Rising</a>
  </div>

  <h1>News Trends</h1>

  <div class="row">
    <input id="terms" placeholder="Terms (comma separated)">
    <input id="tickers" placeholder="Tickers, e.g. AAPL,MSFT">
    <button id="btnPick">Select tickers</button>
    <button id="btnTop">Top terms</button>
    <button id="btnClear">Clear</button>
  </div>

  <div class="grid">
    <div class="card"><canvas id="termsChart"></canvas></div>
    <div class="card"><canvas id="pricesChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:16px">
    <canvas id="articlesChart"></canvas>
  </div>

  <div class="hint">Hard-refresh if stale data appears.</div>
</div>

<div id="modal" class="modal">
  <div class="sheet">
    <div class="sectbar">
      <h3>Select tickers by sector</h3>
      <div>
        <button class="sbtn" id="btnAll">All</button>
        <button class="sbtn" id="btnNone">None</button>
        <button class="sbtn" id="btnClose">Close</button>
        <button class="sbtn" id="btnApply">Apply</button>
      </div>
    </div>
    <div id="sectorGrid" class="grid2"></div>
  </div>
</div>

<script>
(async function(){
  const v = Date.now();
  async function getJSON(p){
    try{
      const r = await fetch('./data/'+p+'?v='+v,{cache:'no-store'});
      if(!r.ok) return null;
      return r.json();
    }catch(e){
      console.error('fetch error',p,e);
      return null;
    }
  }

  let trends = await getJSON('trends.json');
  let prices = await getJSON('prices.json');
  let articles = await getJSON('articles.json');
  let tickermap = await getJSON('tickers.json');

  const termsInput = document.getElementById('terms');
  const tickersInput = document.getElementById('tickers');
  const btnTop = document.getElementById('btnTop');
  const btnClear = document.getElementById('btnClear');
  const btnPick = document.getElementById('btnPick');

  const gridColor = '#1f2937';

  const tc = new Chart(document.getElementById('termsChart').getContext('2d'),{
    type:'line',
    data:{labels:Array.isArray(trends && trends.dates)? trends.dates:[],datasets:[]},
    options:{
      responsive:true,
      plugins:{legend:{display:true}},
      scales:{x:{grid:{color:gridColor}},y:{grid:{color:gridColor}}}
    }
  });

  const pc = new Chart(document.getElementById('pricesChart').getContext('2d'),{
    type:'line',
    data:{labels:Array.isArray(prices && prices.dates)? prices.dates:[],datasets:[]},
    options:{
      responsive:true,
      plugins:{legend:{display:true}},
      scales:{x:{grid:{color:gridColor}},y:{grid:{color:gridColor}}}
    }
  });

  const ac = new Chart(document.getElementById('articlesChart').getContext('2d'),{
    type:'bar',
    data:{
      labels:Array.isArray(articles && articles.dates)? articles.dates:[],
      datasets:[{label:'articles',data:Array.isArray(articles && articles.articles)? articles.articles:[]}]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:true}},
      scales:{x:{grid:{color:gridColor}},y:{grid:{color:gridColor}}}
    }
  });

  function getTopTermsFromTopArray(topArr){
    if(!Array.isArray(topArr)) return [];
    const names = topArr.map(x=>{
      if(typeof x==='string') return x;
      if(Array.isArray(x)) return x[0];
      if(x && typeof x.term==='string') return x.term;
      return null;
    }).filter(Boolean);
    return names;
  }

  function safeTop10(){
    if(!trends || typeof trends!=='object') return [];
    let names = [];
    if(Array.isArray(trends.top) && trends.top.length>0){
      names = getTopTermsFromTopArray(trends.top);
      if(names.length) return names.slice(0,10);
    }
    if(trends.series && typeof trends.series==='object'){
      let termList = [];
      if(Array.isArray(trends.terms) && trends.terms.length){
        termList = trends.terms;
      }else{
        termList = Object.keys(trends.series);
      }
      const sums = termList.map(t=>{
        const arr = Array.isArray(trends.series[t])? trends.series[t]:[];
        const total = arr.reduce((a,b)=>a + (Number(b)||0),0);
        return [t,total];
      });
      sums.sort((a,b)=>b[1]-a[1]);
      return sums.slice(0,10).map(x=>x[0]);
    }
    return [];
  }

  function updateTerms(sel){
    if(!trends || !trends.series) return;
    const names = Array.isArray(sel) && sel.length? sel:safeTop10();
    const seriesObj = trends.series||{};
    const labels = Array.isArray(trends.dates)? trends.dates:[];
    const ds = names
      .filter(n=>seriesObj[n])
      .map(t=>({
        label:t,
        data:seriesObj[t].map(v=>Number(v)||0),
        borderWidth:2,
        pointRadius:0
      }));
    tc.data.labels = labels;
    tc.data.datasets = ds;
    tc.update();
  }

  function updatePrices(tickers){
    if(!prices || !Array.isArray(prices.dates) || !prices.close) return;
    const want = Array.isArray(tickers)? tickers.map(s=>s.toUpperCase()):[];
    const allTickers = Array.isArray(prices.tickers)? prices.tickers:[];
    const labels = prices.dates;
    const ds = want
      .filter(t=>allTickers.includes(t) && Array.isArray(prices.close[t]))
      .map(t=>({
        label:t,
        data:prices.close[t].map(v=>{
          if(v===null || v===undefined) return null;
          const n = Number(v);
          return Number.isFinite(n)? n:null;
        }),
        borderWidth:2,
        pointRadius:0
      }));
    pc.data.labels = labels;
    pc.data.datasets = ds;
    pc.update();
  }

  btnTop.onclick = function(){
    const top10 = safeTop10();
    termsInput.value = top10.join(',');
    updateTerms(top10);
  };

  btnClear.onclick = function(){
    termsInput.value = '';
    tickersInput.value = '';
    updateTerms([]);
    updatePrices([]);
  };

  const applyTickers = function(){
    const sel = tickersInput.value.split(',').map(s=>s.trim()).filter(Boolean);
    updatePrices(sel);
  };

  tickersInput.addEventListener('change',applyTickers);
  tickersInput.addEventListener('keyup',function(e){
    if(e.key==='Enter') applyTickers();
  });
  tickersInput.addEventListener('blur',applyTickers);

  const modal = document.getElementById('modal');
  const sectorGrid = document.getElementById('sectorGrid');
  const btnClose = document.getElementById('btnClose');
  const btnApply = document.getElementById('btnApply');
  const btnAll = document.getElementById('btnAll');
  const btnNone = document.getElementById('btnNone');

  btnPick.onclick = function(){
    renderSectors();
    modal.style.display = 'flex';
  };

  btnClose.onclick = function(){
    modal.style.display = 'none';
  };

  function renderSectors(){
    if(!tickermap || typeof tickermap!=='object'){
      sectorGrid.innerHTML = '<div>No tickers.json</div>';
      return;
    }
    sectorGrid.innerHTML = '';
    Object.entries(tickermap).forEach(function(entry){
      const sector = entry[0];
      const arr = entry[1];
      const box = document.createElement('div');
      box.className = 'sec';
      const list = (Array.isArray(arr)? arr:[]).map(function(t){
        return '<label style="display:inline-block;margin:4px 8px 4px 0"><input type="checkbox" class="tbox" value="'+t+'"> '+t+'</label>';
      }).join('');
      box.innerHTML = '<h4>'+sector+'</h4>'+list;
      sectorGrid.appendChild(box);
    });
  }

  btnAll.onclick = function(){
    document.querySelectorAll('.tbox').forEach(function(ch){ ch.checked = true; });
  };

  btnNone.onclick = function(){
    document.querySelectorAll('.tbox').forEach(function(ch){ ch.checked = false; });
  };

  btnApply.onclick = function(){
    const sel = Array.from(document.querySelectorAll('.tbox:checked')).map(function(x){ return x.value; });
    tickersInput.value = sel.join(',');
    modal.style.display = 'none';
    updatePrices(sel);
  };

  updateTerms([]);
  if(prices && Array.isArray(prices.tickers) && prices.tickers.length>0){
    const first = String(prices.tickers[0]).toUpperCase();
    tickersInput.value = first;
    updatePrices([first]);
  }
})();
</script>
</body>
</html>