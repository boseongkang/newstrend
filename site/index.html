<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>News Trends</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>window.Chart||document.write('<script src="https://unpkg.com/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous"><\/script>')</script>
<script>window.Chart||document.write('<script src="./vendor/chart.umd.min.js"><\/script>')</script>
<style>
  body{margin:0;background:#0b0f18;color:#e6e8ec;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px;position:relative}
  h1{font-size:24px;margin:0 0 16px}
  .nav{position:absolute;right:16px;top:12px;display:flex;gap:8px}
  .pill{background:#253bff;color:#fff;border-radius:10px;padding:8px 12px;text-decoration:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#121826;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input{background:#0f1523;border:1px solid #243043;color:#e6e8ec;border-radius:10px;padding:10px 12px;min-width:220px}
  button{background:#253bff;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .hint{opacity:.7;font-size:12px;margin-top:6px}
  canvas{width:100%;height:360px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px}
  .sheet{max-width:900px;width:100%;max-height:80vh;overflow:auto;background:#0f1523;border:1px solid #243043;border-radius:12px;padding:16px}
  .sec{margin-bottom:10px}
  .sec h4{margin:10px 0}
  .grid2{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .sectbar{display:flex;justify-content:space-between;align-items:center}
  .sbtn{background:#263249;border:1px solid #2f3b57;color:#cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <a href="./index.html" class="pill">Trends</a>
    <a href="./report.html" class="pill">Report</a>
    <a href="./rising.html" class="pill">Rising</a>
  </div>

  <h1>News Trends</h1>

  <div class="row">
    <input id="terms" placeholder="Terms (comma separated)">
    <input id="tickers" placeholder="Tickers, e.g. AAPL,MSFT">
    <button id="btnPick">Select tickers</button>
    <button id="btnTop">Top terms</button>
    <button id="btnClear">Clear</button>
  </div>

  <div class="grid">
    <div class="card"><canvas id="termsChart"></canvas></div>
    <div class="card"><canvas id="pricesChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:16px">
    <canvas id="articlesChart"></canvas>
  </div>

  <div class="hint">Hard-refresh if stale data appears.</div>
</div>

<div id="modal" class="modal">
  <div class="sheet">
    <div class="sectbar">
      <h3>Select tickers by sector</h3>
      <div>
        <button class="sbtn" id="btnAll">All</button>
        <button class="sbtn" id="btnNone">None</button>
        <button class="sbtn" id="btnClose">Close</button>
        <button class="sbtn" id="btnApply">Apply</button>
      </div>
    </div>
    <div id="sectorGrid" class="grid2"></div>
  </div>
</div>

<script>
(async function(){
  const v = Date.now();
  const gridColor = '#1f2937';

  async function getJSON(p){
    const url = './data/'+p+'?v='+v;
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok){ console.error('GET failed', p, r.status); throw new Error(p+' '+r.status); }
    return r.json();
  }

  let trends=null, prices=null, articles=null, tickermap=null;
  try{ trends    = await getJSON('trends.json'); }catch(e){ console.error('trends.json', e); }
  try{ prices    = await getJSON('prices.json'); }catch(e){ console.warn('prices optional', e); }
  try{ articles  = await getJSON('articles.json'); }catch(e){ console.error('articles.json', e); }
  try{ tickermap = await getJSON('tickers.json'); }catch(e){ console.warn('tickers list missing', e); }

  const termsInput   = document.getElementById('terms');
  const tickersInput = document.getElementById('tickers');
  const btnTop   = document.getElementById('btnTop');
  const btnClear = document.getElementById('btnClear');
  const btnPick  = document.getElementById('btnPick');

  const tc = new Chart(document.getElementById('termsChart').getContext('2d'),{
    type:'line',
    data:{labels: trends?.dates||[], datasets:[]},
    options:{responsive:true,plugins:{legend:{display:true}},
      scales:{x:{grid:{color:gridColor}},y:{grid:{color:gridColor}}}}
  });

  const pc = new Chart(document.getElementById('pricesChart').getContext('2d'),{
    type:'line',
    data:{labels: prices?.dates||[], datasets:[]},
    options:{responsive:true,plugins:{legend:{display:true}}},
    plugins:[]
  });
  pc.options.scales = {x:{grid:{color:gridColor}},y:{grid:{color:gridColor}}};

  const ac = new Chart(document.getElementById('articlesChart').getContext('2d'),{
    type:'bar',
    data:{labels: articles?.dates||[], datasets:[{label:'articles', data: articles?.articles||[]}]},
    options:{responsive:true,plugins:{legend:{display:true}},
      scales:{x:{grid:{color:gridColor}},y:{grid:{color:gridColor}}}}
  });

  function safeTop10(){
    if (Array.isArray(trends?.top) && trends.top.length) return trends.top.slice(0,10);
    if (trends?.series && Array.isArray(trends?.terms)) {
      const sums = trends.terms.map(t => [t, (trends.series[t]||[]).reduce((a,b)=>a + (+b||0), 0)]);
      sums.sort((a,b)=>b[1]-a[1]);
      return sums.slice(0,10).map(([t])=>t);
    }
    return [];
  }

  function availableTickers(){
    const a = Array.isArray(prices?.tickers)? prices.tickers: [];
    const close = prices?.close && typeof prices.close==='object'? Object.keys(prices.close): [];
    const adj   = prices?.adj_close && typeof prices.adj_close==='object'? Object.keys(prices.adj_close): [];
    const series= prices?.series && typeof prices.series==='object'? Object.keys(prices.series): [];
    const uniq = [...new Set([...a, ...close, ...adj, ...series])];
    if(!uniq.length) console.warn('No tickers found in prices.json (expect tickers[] or close{} / adj_close{} / series{} keys).');
    return uniq;
  }

  function selectSeriesFor(t){
    return (prices?.close?.[t])
        || (prices?.adj_close?.[t])
        || (prices?.series?.[t])
        || [];
  }

  function toNum(v){
    return (v===null || v===undefined || (typeof v==='string' && v.trim()==='')) ? null : Number(v);
  }

  function updateTerms(sel){
    if(!trends) return;
    const names = (Array.isArray(sel) && sel.length) ? sel : safeTop10();
    const ds = names
      .filter(n => trends.terms?.includes(n))
      .map(t => ({label:t, data:(trends.series?.[t]||[]).map(x => +x||0), borderWidth:2, pointRadius:0}));
    tc.data.labels = trends.dates||[];
    tc.data.datasets = ds;
    tc.update();
  }

  function updatePrices(tickers){
    if(!prices) return;
    const want = (tickers||[]).map(s=>s.toUpperCase());
    const ds = want
      .filter(t => availableTickers().includes(t))
      .map(t => ({ label:t, data: selectSeriesFor(t).map(toNum), borderWidth:2, pointRadius:0 }));
    pc.data.labels = prices.dates||[];
    pc.data.datasets = ds;
    pc.update();
  }

  btnTop.onclick = () => {
    const top10 = safeTop10();
    termsInput.value = top10.join(',');
    updateTerms(top10);
  };
  btnClear.onclick = () => { termsInput.value=''; tickersInput.value=''; updateTerms([]); updatePrices([]); };

  function applyTerms(){
    const sel = termsInput.value.split(',').map(s=>s.trim()).filter(Boolean);
    updateTerms(sel);
  }
  termsInput.addEventListener('change', applyTerms);
  termsInput.addEventListener('keyup', e => { if(e.key==='Enter') applyTerms(); });
  termsInput.addEventListener('blur', applyTerms);

  const applyTickers = () => {
    const sel = tickersInput.value.split(',').map(s=>s.trim()).filter(Boolean);
    updatePrices(sel);
  };
  tickersInput.addEventListener('change', applyTickers);
  tickersInput.addEventListener('keyup', e => { if(e.key==='Enter') applyTickers(); });
  tickersInput.addEventListener('blur', applyTickers);

  const modal = document.getElementById('modal');
  const sectorGrid = document.getElementById('sectorGrid');
  const btnClose = document.getElementById('btnClose');
  const btnApply = document.getElementById('btnApply');
  const btnAll = document.getElementById('btnAll');
  const btnNone = document.getElementById('btnNone');

  btnPick.onclick = () => { renderSectors(); modal.style.display='flex'; };
  btnClose.onclick = () => { modal.style.display='none'; };

  function renderSectors(){
    if(!tickermap){ sectorGrid.innerHTML = '<div>No tickers.json</div>'; return; }
    sectorGrid.innerHTML = '';
    const current = new Set(tickersInput.value.split(',').map(s=>s.trim()).filter(Boolean));
    Object.entries(tickermap).forEach(([sector, arr])=>{
      const box = document.createElement('div');
      box.className='sec';
      const list = arr.map(t => {
        const checked = current.has(t) ? 'checked' : '';
        return `<label style="display:inline-block;margin:4px 8px 4px 0">
                  <input type="checkbox" class="tbox" value="${t}" ${checked}> ${t}
                </label>`;
      }).join('');
      box.innerHTML = `<h4>${sector}</h4>${list}`;
      sectorGrid.appendChild(box);
    });
  }

  btnAll.onclick  = () => document.querySelectorAll('.tbox').forEach(ch => ch.checked = true);
  btnNone.onclick = () => document.querySelectorAll('.tbox').forEach(ch => ch.checked = false);

  btnApply.onclick = () => {
    const sel = Array.from(document.querySelectorAll('.tbox:checked')).map(x=>x.value);
    tickersInput.value = sel.join(',');
    modal.style.display='none';
    updatePrices(sel);
  };

  updateTerms([]);

  const defaults = availableTickers();
  if (defaults.length){
    tickersInput.value = defaults[0];
    updatePrices([defaults[0]]);
    console.log('Initial ticker:', defaults[0], 'All available tickers:', defaults);
  } else {
    console.warn('Prices chart idle. Check site/data/prices.json structure.');
  }
})();
</script>
</body>
</html>