<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>News Trends Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0b0f18;--card:#121826;--line:#1f2937;--txt:#e6e8ec;--accent:#3b82f6}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{font-weight:700;font-size:22px}
  .nav a{color:#cbd5e1;text-decoration:none;margin-left:12px;padding:8px 10px;border-radius:10px}
  .nav a.active{background:var(--accent);color:#fff}
  .row{display:flex;gap:8px;align-items:center;margin:12px 0}
  input{background:#0f1523;border:1px solid #243043;color:#e6e8ec;border-radius:10px;padding:10px 12px;min-width:220px}
  button{background:#253bff;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  canvas{width:100%;height:360px}
  .hint{opacity:.7;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">News Trends</div>
    <div class="nav">
      <a class="active" href="./index.html">Trends</a>
      <a href="./report.html">Report</a>
      <a href="./rising.html">Rising</a>
    </div>
  </div>

  <div class="row">
    <input id="terms" placeholder="Terms (comma separated)">
    <input id="tickers" placeholder="Tickers, e.g. AAPL,MSFT">
    <button id="btnTop" type="button">Top terms</button>
    <button id="btnClear" type="button">Clear</button>
    <button id="btnRising" type="button">Rising</button>
  </div>

  <div class="grid">
    <div class="card"><canvas id="termsChart"></canvas></div>
    <div class="card"><canvas id="pricesChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:16px">
    <canvas id="articlesChart"></canvas>
  </div>

  <div class="hint">Hard-refresh if stale data appears.</div>
</div>

<script>
(async function(){
  const v = Date.now();
  async function getJSON(p){
    const res = await fetch('./data/'+p+'?v='+v,{cache:'no-store'});
    if(!res.ok) throw new Error(p+' '+res.status);
    return await res.json();
  }
  let trends=null, prices=null, articles=null;
  try{ trends = await getJSON('trends.json'); }catch(e){ console.error(e); }
  try{ prices = await getJSON('prices.json'); }catch(e){ console.warn('prices optional', e); }
  try{ articles = await getJSON('articles.json'); }catch(e){ console.error(e); }

  const termsInput = document.getElementById('terms');
  const tickersInput = document.getElementById('tickers');
  const btnTop = document.getElementById('btnTop');
  const btnClear = document.getElementById('btnClear');
  const btnRising = document.getElementById('btnRising');

  const tc = new Chart(document.getElementById('termsChart').getContext('2d'),{
    type:'line',
    data:{labels: trends? trends.dates: [], datasets:[]},
    options:{responsive:true,plugins:{legend:{display:true}},elements:{point:{radius:0}},scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}}}
  });
  const pc = new Chart(document.getElementById('pricesChart').getContext('2d'),{
    type:'line',
    data:{labels: prices? prices.dates: [], datasets:[]},
    options:{responsive:true,plugins:{legend:{display:true}},elements:{point:{radius:0}},scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}}}
  });
  const ac = new Chart(document.getElementById('articlesChart').getContext('2d'),{
    type:'bar',
    data:{labels: articles? articles.dates: [], datasets:[{label:'articles', data: articles? articles.articles: []}]},
    options:{responsive:true,plugins:{legend:{display:true}},scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}}}
  });

  function updateTerms(sel){
    if(!trends) return;
    const names = sel && sel.length? sel: trends.top.slice(0,10);
    const ds = names.filter(n => trends.terms.includes(n)).map(t=>({label:t,data:trends.series[t]||[],borderWidth:2}));
    tc.data.labels = trends.dates;
    tc.data.datasets = ds;
    tc.update();
  }
  function updatePrices(tickers){
    if(!prices) return;
    const names = tickers && tickers.length? tickers: [];
    const ds = names.filter(n => prices.tickers.includes(n)).map(t=>({label:t,data:(prices.close[t]||[]).map(v=>v==null?null:Number(v)),borderWidth:2}));
    pc.data.labels = prices.dates;
    pc.data.datasets = ds;
    pc.update();
  }

  btnTop.onclick = () => {
    termsInput.value = (trends? trends.top.slice(0,10): []).join(',');
    updateTerms(termsInput.value.split(',').map(s=>s.trim()).filter(Boolean));
  };
  btnClear.onclick = () => {
    termsInput.value = ''; tickersInput.value = '';
    updateTerms([]); updatePrices([]);
  };
  btnRising.onclick = () => { window.location.href = './rising.html'; };

  termsInput.addEventListener('change', () => {
    const sel = termsInput.value.split(',').map(s=>s.trim()).filter(Boolean);
    updateTerms(sel);
  });
  tickersInput.addEventListener('change', () => {
    const sel = tickersInput.value.split(',').map(s=>s.trim()).filter(Boolean);
    updatePrices(sel);
  });

  updateTerms([]);
  updatePrices([]);
})();
</script>
</body>
</html>