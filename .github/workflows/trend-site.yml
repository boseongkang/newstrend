name: trend-site
on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Download latest warehouse artifact

      - uses: dawidd6/action-download-artifact@v3
        with:
          workflow: entities-report.yml
          branch: main
          name: entities-site
          path: report_art
          allow_forks: true
        continue-on-error: true

      - name: Merge report into site
        run: |
          mkdir -p site/report
          if [ -d report_art ]; then cp -r report_art/

      - name: Restore warehouse
        run: |
          set -euo pipefail
          mkdir -p data/warehouse/daily
          SRC=artifacts
          if [ -d artifacts/warehouse ]; then SRC=artifacts/warehouse; fi
          rsync -a "$SRC"/ data/warehouse/
          echo "days in warehouse:" $(find data/warehouse/daily -name '*.jsonl' | wc -l)

      - name: Aggregate and rising
        run: |
          set -euo pipefail
          python scripts/aggregate_from_warehouse.py \
            --warehouse data/warehouse/daily \
            --out run \
            --last-days 30 \
            --min-len 4 \
            --extra-stop config/extra_noise.txt
          python scripts/join_prices.py --run run || true

      - name: Build static site
        run: |
          set -euo pipefail
          python scripts/build_static_ui.py --run run --out site
          echo "articles days:" $(jq '.dates|length' site/data/articles.json)

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
