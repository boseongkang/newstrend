name: trend-site
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download latest warehouse artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: update-warehouse.yml
          name: warehouse
          allow_forks: true
          path: artifacts

      - name: Restore warehouse
        run: |
          set -euo pipefail
          mkdir -p data/warehouse
          if [ -d artifacts/data/warehouse ]; then
            SRC="artifacts/data/warehouse/"
          elif [ -d artifacts/warehouse ]; then
            SRC="artifacts/warehouse/"
          else
            echo "Warehouse dir not found in downloaded artifact"
            echo "::group::Artifacts layout"
            find artifacts -maxdepth 3 -print
            echo "::endgroup::"
            exit 23
          fi
          rsync -av --delete "$SRC" data/warehouse/
          ls -l data/warehouse | head

      - name: Aggregate and rising
        run: |
          set -euo pipefail
          python scripts/aggregate_from_warehouse.py \
            --warehouse data/warehouse/daily \
            --out run \
            --last-days 30 \
            --min-len 4 \
            --extra-stop config/extra_noise.txt
          python scripts/make_rising.py \
            --tokens-csv run/tokens_by_day.cleaned.csv \
            --out run/rising_csv --top 50
          DATES=$(awk -F, 'NR>1{print $1}' run/aggregate/articles_by_day.csv | sort -u | wc -l)
          echo "unique dates in articles: $DATES"
          if [ "$DATES" -lt 2 ]; then echo "only $DATES day; failing"; exit 1; fi

      - name: Build static site
        run: |
          set -euo pipefail
          python scripts/build_static_ui.py --run run --out site
          touch site/.nojekyll
          echo "unique dates in tokens:" $(awk -F, 'NR>1{print $1}' run/tokens_by_day.cleaned.csv | sort -u | wc -l)
          echo "unique dates in articles:" $(awk -F, 'NR>1{print $1}' run/aggregate/articles_by_day.csv | sort -u | wc -l)

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/deploy-pages@v4
