name: daily-news
on:
  schedule:
    - cron: "00 9 * * *"
  workflow_dispatch: {}
permissions:
  contents: read
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      - name: Compute ISO (yesterday)
        id: when
        shell: bash
        run: |
          if date -u -d yesterday +%F >/dev/null 2>&1; then
            D=$(date -u -d yesterday +%F)
          else
            D=$(date -u -v-1d +%F)
          fi
          echo "date=$D" >> "$GITHUB_OUTPUT"
          echo "INGEST_DATE=$D" >> "$GITHUB_ENV"
      - name: Ingest hourly (NewsAPI)
        if: ${{ env.NEWSAPI_KEY != '' }}
        run: |
          newscli ingest-hourly --date "${{ steps.when.outputs.date }}" --hours-split 2 --query "news"
      - name: Aggregate day
        if: ${{ env.NEWSAPI_KEY != '' }}
        run: |
          newscli aggregate --date "${{ steps.when.outputs.date }}"
      - name: Find input for report
        id: in
        run: |
          D="${{ steps.when.outputs.date }}"
          if [ -f "data/raw_newsapi/$D.jsonl" ]; then
            echo "in=data/raw_newsapi/$D.jsonl" >> "$GITHUB_OUTPUT"
          elif [ -f "data/silver_newsapi/$D.jsonl" ]; then
            echo "in=data/silver_newsapi/$D.jsonl" >> "$GITHUB_OUTPUT"
          else
            echo "in=" >> "$GITHUB_OUTPUT"
          fi
      - name: Generate daily report
        if: ${{ steps.in.outputs.in != '' }}
        run: |
          python src/news_trend/report.py \
            --date "${{ steps.when.outputs.date }}" \
            --indir data \
            --kind raw_newsapi \
            --outdir reports \
            --top 30
      - name: Append summary
        if: ${{ steps.in.outputs.in != '' }}
        run: |
          D=${{ steps.when.outputs.date }}
          {
            echo "### Daily run"
            echo "- Date (UTC): $D"
            echo "- Input: ${{ steps.in.outputs.in }}"
            echo "- Latest: reports/latest.html"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Upload artifact (daily report)
        if: ${{ steps.in.outputs.in != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ steps.when.outputs.date }}
          path: reports
          if-no-files-found: error
          retention-days: 7