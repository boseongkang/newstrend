name: update-warehouse
on:
  workflow_dispatch:
  schedule:
    - cron: "23 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install pandas numpy pyyaml || true

      - name: Download previous warehouse artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: update-warehouse.yml
          name: warehouse
          path: prev_warehouse
          if_no_artifact_found: ignore

      - name: Restore previous warehouse
        run: |
          set -euo pipefail
          mkdir -p data/warehouse/daily
          SRC=prev_warehouse
          if [ -d prev_warehouse/warehouse ]; then SRC=prev_warehouse/warehouse; fi
          if [ -d "$SRC" ]; then rsync -a "$SRC"/ data/warehouse/; fi

      - name: Download latest live jsonl
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: collect_continuous.yml
          name: live-jsonl
          path: live_artifacts
          if_no_artifact_found: ignore

      - name: Restore live inputs
        run: |
          set -euo pipefail
          mkdir -p data/live_newsapi
          mv live_artifacts/*.jsonl data/live_newsapi/ || true
          ls -l data/live_newsapi || true

      - name: Update corpus
        run: |
          set -euo pipefail
          python scripts/update_corpus.py

      - name: Extract terms to daily CSV
        run: |
          set -euo pipefail
          DT="$(date -u +%F)"
          python scripts/extract_terms.py \
            --inputs "data/live_newsapi/*.jsonl" "data/warehouse/daily/${DT}.jsonl" "data/warehouse/master.jsonl" \
            --outcsv "data/warehouse/daily/${DT}.csv" \
            --date "$DT" \
            --topk 800 --minlen 2 --mincount 2 \
            --max-ngram 3 \
            --stop configs/stopwords_en.txt \
            --alias configs/alias_en.yml

      - name: Mirror CSV to JSONL
        shell: bash
        run: |
          python - <<'PY'
          import pandas as pd, json, pathlib
          p = pathlib.Path("data/warehouse/daily")
          p.mkdir(parents=True, exist_ok=True)
          for f in sorted(p.glob("*.csv")):
              j = f.with_suffix(".jsonl")
              df = pd.read_csv(f)
              with j.open("w", encoding="utf-8") as out:
                  for r in df.itertuples(index=False):
                      out.write(json.dumps({"date":str(r.date)[:10],"entity":str(r.entity),"count":int(r.count)}, ensure_ascii=False)+"\n")
          print("mirrored")
          PY

      - name: Upload warehouse artifact
        uses: actions/upload-artifact@v4
        with:
          name: warehouse
          path: |
            data/warehouse/master.jsonl
            data/warehouse/daily